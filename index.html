<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Portafolio</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        :root {
            --dark-navy: #0a192f;
            --navy: #112240;
            --light-navy: #1d3b5b;
            --slate: #8892b0;
            --light-slate: #a8b2d1;
            --lightest-slate: #ccd6f6;
            --gold: #FFC300;
            --main-blue: #36A2EB;
            --positive: #28a745;
            --negative: #dc3545;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--dark-navy); 
            color: var(--slate);
            padding: 2rem;
        }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(10, 25, 47, 0.9); display: flex; justify-content: center; align-items: center; z-index: 10001; color: var(--lightest-slate); font-size: 1.5rem; }
        .main-container { max-width: 1600px; margin: 0 auto; display: none; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .header h1 { color: var(--lightest-slate); font-size: 2rem; display: flex; align-items: center; gap: 1rem; }
        .header-icon { background-color: var(--navy); color: var(--lightest-slate); padding: 0.75rem; border-radius: 8px; }
        .currency-toggle { display: flex; border: 1px solid var(--light-navy); border-radius: 8px; overflow: hidden; }
        .toggle-btn { background: transparent; color: var(--slate); border: none; padding: 8px 18px; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
        .toggle-btn.active { background: var(--lightest-slate); color: var(--dark-navy); }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .kpi-card { background-color: var(--navy); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--gold); text-align: center; }
        .kpi-card.quant { border-left-color: var(--main-blue); }
        .kpi-card h3 { color: var(--slate); font-size: 0.9rem; text-transform: uppercase; margin-bottom: 0.5rem; font-weight: 500; }
        .kpi-card .value { color: var(--lightest-slate); font-size: 2rem; font-weight: 700; transition: font-size 0.2s ease-in-out; }
        .kpi-card.ars-active .value { font-size: 1.6rem; }
        .kpi-card .sub-value { color: var(--slate); font-size: 0.9rem; }
        .kpi-card .value.negative, .kpi-card .sub-value.negative { color: var(--negative); }
        .kpi-card .value.positive, .kpi-card .sub-value.positive { color: var(--positive); }
        .content-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 2rem; margin-bottom: 2rem; }
        .widget { background-color: var(--navy); padding: 1.5rem; border-radius: 8px; }
        .widget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .widget-title { color: var(--lightest-slate); font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem; }
        .filter-buttons { display: flex; gap: 0.5rem; }
        .filter-btn { background-color: var(--light-navy); color: var(--slate); border: none; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 0.8rem; transition: all 0.2s ease-in-out; }
        .filter-btn.active { background-color: var(--gold); color: #0a192f; border: 1px solid var(--gold); }
        .chart-wrapper { height: 350px; position: relative; }
        .full-width-widget { grid-column: 1 / -1; margin-top: 2rem; }
        .summary-tables-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem; align-items: stretch; }
        .summary-tables-grid .widget { display: flex; flex-direction: column; }
        .table-wrapper { flex-grow: 1; overflow-y: auto; max-height: 280px; }
        .summary-tables-grid .table-wrapper { max-height: none; overflow-y: visible; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-navy); }
        .data-table thead th { background-color: var(--navy); color: var(--light-slate); font-weight: 600; position: sticky; top: 0; z-index: 1; }
        .data-table tbody tr:hover { background-color: var(--light-navy); cursor: pointer; }
        .text-right { text-align: right !important; }
        .text-center { text-align: center !important; }
        .pl-badge { display: inline-block; padding: 5px 12px; border-radius: 15px; color: #fff; font-weight: 600; font-size: 0.9rem; min-width: 70px; text-align: center; }
        .pl-badge.positive { background-color: var(--positive); }
        .pl-badge.negative { background-color: var(--negative); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 25, 47, 0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .modal-content { background-color: var(--navy); color: var(--lightest-slate); border-radius: 12px; padding: 2rem; width: 90%; max-width: 800px; border: 1px solid var(--light-navy); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-navy); padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.8rem; }
        .close-modal { background: none; border: none; color: var(--slate); font-size: 2rem; cursor: pointer; }
        #asset-chart-container { height: 300px; margin-bottom: 1.5rem; }
        .modal-kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; text-align: center;}
        .modal-kpi h4 { color: var(--slate); font-size: 0.9rem; margin-bottom: 0.5rem; }
        .modal-kpi p { font-size: 1.2rem; font-weight: bold; }
        .simulator-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; align-items: center; }
        .simulator-control { display: flex; flex-direction: column; gap: 0.5rem; }
        .simulator-control label { font-weight: 600; color: var(--light-slate); }
        .simulator-control input[type="range"] { -webkit-appearance: none; width: 100%; height: 8px; background: var(--light-navy); border-radius: 5px; outline: none; }
        .simulator-control input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--gold); cursor: pointer; border-radius: 50%; }
        .simulator-result { text-align: center; font-size: 1.5rem; font-weight: bold; color: var(--lightest-slate); }
        @media (max-width: 1200px) { .content-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { body { padding: 1rem; } .header { flex-direction: column; align-items: flex-start; gap: 1rem; } .kpi-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <div id="loading-overlay"><h1>Cargando Portafolio...</h1></div>
    <div class="main-container">
        <header class="header">
            <h1 class="header-title"><span class="header-icon">üìà</span>Dashboard de Portafolio</h1>
            <div class="currency-toggle">
                <button class="toggle-btn active" id="btn-usd">USD</button>
                <button class="toggle-btn" id="btn-ars">ARS</button>
            </div>
        </header>

        <section class="kpi-grid">
            <div class="kpi-card"><h3>Valor Total</h3><div class="value" id="valorTotal">...</div><div class="sub-value" id="valorTotalDiario">...</div></div>
            <div class="kpi-card"><h3>GCIAS. REALIZADAS</h3><div class="value" id="ganRealizadas">...</div></div>
            <div class="kpi-card"><h3>GCIAS. NO REALIZADAS</h3><div class="value" id="ganNoRealizadas">...</div></div>
            <div class="kpi-card"><h3>TIR Renta Variable</h3><div class="value" id="tirVariable">...</div></div>
            <div class="kpi-card"><h3>TIR Renta Fija</h3><div class="value" id="tirFija">...</div></div>
        </section>

        <section class="kpi-grid">
            <div class="kpi-card quant"><h3>Volatilidad Anualizada</h3><div class="value" id="volatilidadAnualizada">...</div></div>
            <div class="kpi-card quant"><h3>Sharpe Ratio</h3><div class="value" id="sharpeRatio">...</div></div>
            <div class="kpi-card quant"><h3>Beta de la Cartera</h3><div class="value" id="betaCartera">...</div></div>
            <div class="kpi-card quant"><h3>Max Drawdown</h3><div class="value" id="maxDrawdown">...</div></div>
        </section>
        
        <section class="content-grid full-width-widget">
            <div class="widget" id="distribucion-widget"><div class="widget-header"><h2 class="widget-title"><span class="widget-icon">ü•ß</span>Distribuci√≥n por Tipo de Activo</h2></div><div class="chart-wrapper"><canvas id="assetAllocationChart"></canvas></div></div>
            <div class="widget" id="top-holdings-widget"><div class="widget-header"><h2 class="widget-title"><span class="widget-icon">üèÜ</span>Top Holdings</h2><div class="filter-buttons" id="top-holdings-filters"><button class="filter-btn active" data-category="cedears">Cedears</button><button class="filter-btn" data-category="ons">ONs</button><button class="filter-btn" data-category="bonos">Bonos</button><button class="filter-btn" data-category="acciones">Acciones</button></div></div><div class="chart-wrapper"><canvas id="topHoldingsChart"></canvas></div></div>
        </section>
        
        <!-- HEATMAP ELIMINADO -->

        <section class="widget full-width-widget"><div class="widget-header"><h2 class="widget-title"><span class="widget-icon">üìà</span>Evoluci√≥n vs. Benchmark</h2><div class="filter-buttons" id="evolution-filters"><button class="filter-btn" data-period="7">7 D√≠as</button><button class="filter-btn active" data-period="30">30 D√≠as</button><button class="filter-btn" data-period="ytd">Este A√±o (YTD)</button><button class="filter-btn" data-period="all">Desde Inicio</button></div></div><div class="chart-wrapper"><canvas id="performanceChart"></canvas></div></section>
        <section class="widget full-width-widget"><div class="widget-header"><h2 class="widget-title"><span class="widget-icon">üìñ</span>Mis Posiciones</h2><div class="filter-buttons" id="holdings-table-filters"><button class="filter-btn active" data-category="todos">Todos</button><button class="filter-btn" data-category="Cedear">Cedears</button><button class="filter-btn" data-category="O Negociable">ONs</button><button class="filter-btn" data-category="Bonos">Bonos</button><button class="filter-btn" data-category="Acciones">Acciones</button></div></div><div class="table-wrapper" style="max-height: 400px;"><table class="data-table"><thead><tr><th>Ticker</th><th>Tipo</th><th class="text-right">Costo Inversi√≥n</th><th class="text-right">Valor Actual</th><th class="text-center">Diario %</th><th class="text-center">P/L %</th><th class="text-right">% Cartera</th></tr></thead><tbody id="holdingsTableBody"></tbody></table></div></section>
        
        <!-- Tablas de resumen: Dividendos, Renta Fija -->
        <section class="summary-tables-grid full-width-widget">
            <div class="widget">
                <h2 class="widget-title">üèÜ Top Goleadores de Dividendos</h2>
                <div class="table-wrapper"><table class="data-table"><thead><tr><th>Ticker</th><th class="text-right">Cobrado</th><th class="text-right">%</th></tr></thead><tbody id="dividendosGoleadoresBody"></tbody></table></div>
            </div>
            <div class="widget">
                <h2 class="widget-title">üóìÔ∏è Dividendos por Temporada</h2>
                <div class="table-wrapper"><table class="data-table"><thead><tr><th>A√±o</th><th class="text-right">Cobrado</th><th class="text-right">%</th></tr></thead><tbody id="dividendosTemporadaBody"></tbody></table></div>
            </div>
            <div class="widget">
                <h2 class="widget-title">üõ°Ô∏è Renta Fija por Temporada</h2>
                <div class="table-wrapper"><table class="data-table"><thead><tr><th>A√±o</th><th class="text-right">Cobrado</th><th class="text-right">%</th></tr></thead><tbody id="rentaFijaTemporadaBody"></tbody></table></div>
            </div>
        </section>

        <!-- Flujo Futuro Detallado -->
        <section class="widget full-width-widget">
            <div class="widget-header">
                <h2 class="widget-title">üí∞ Flujo Futuro Detallado (Renta Fija)</h2>
                <div style="text-align: center;">
                    <label for="year-selector" style="color: var(--light-slate);">Seleccionar A√±o:</label>
                    <select id="year-selector" style="background: var(--light-navy); color: var(--lightest-slate); border: 1px solid var(--slate); border-radius: 5px; padding: 5px;"></select>
                </div>
            </div>
            <div id="flujoAnualTotal" style="text-align: right; color: var(--lightest-slate); padding: 0 1rem 1rem 1rem; font-weight: bold;"></div>
            <div class="table-wrapper" style="max-height: 400px;"><table class="data-table"><thead><tr><th>Ticker</th><th>Fecha</th><th class="text-right">Renta</th><th class="text-right">Capital</th><th class="text-right">Total</th></tr></thead><tbody id="flujoDetalladoBody"></tbody></table></div>
        </section>
        
        <!-- Simulador de Escenarios (Mantiene su posici√≥n) -->
        <section class="widget full-width-widget">
            <div class="widget-header">
                <h2 class="widget-title"><span>üß™</span>Simulador de Escenarios</h2>
            </div>
            <div class="simulator-grid">
                <div class="simulator-control">
                    <label for="spy-slider">Variaci√≥n S&P 500 (SPY)</label>
                    <input type="range" id="spy-slider" min="-20" max="20" value="0" step="0.5">
                    <span id="spy-slider-value">0.0%</span>
                </div>
                <div class="simulator-control">
                    <label for="ccl-slider">Variaci√≥n D√≥lar CCL</label>
                    <input type="range" id="ccl-slider" min="-20" max="20" value="0" step="0.5">
                    <span id="ccl-slider-value">0.0%</span>
                </div>
                <div class="simulator-result">
                    <p>Valor Simulado:</p>
                    <p id="simulated-value">--</p>
                </div>
            </div>
        </section>
        
        <div class="modal-overlay" id="asset-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="modal-ticker-title"></h2>
                    <button class="close-modal" id="close-asset-modal">√ó</button>
                </div>
                <div id="asset-chart-container"><canvas id="assetPriceChart"></canvas></div>
                <div class="modal-kpis">
                    <div class="modal-kpi"><h4>Valor Actual</h4><p id="modal-valor-actual"></p></div>
                    <div class="modal-kpi"><h4>Costo Total</h4><p id="modal-costo-total"></p></div>
                    <div class="modal-kpi"><h4>P/L % Total</h4><p id="modal-pl-total"></p></div>
                    <div class="modal-kpi"><h4>Flujos Cobrados</h4><p id="modal-flujos-cobrados"></p></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzORq-qZYr0HzV7S8XVoWCRev15BWe9lexJUeNztrtWqhndseVMwjucIZ0uPOAryNk/exec'; 

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error(`Error de Red/Permisos (${response.status})`);
                const fullData = await response.json();
                if (fullData.error) throw new Error(fullData.message);
                
                document.getElementById('loading-overlay').style.display = 'none';
                document.querySelector('.main-container').style.display = 'block';

                let currentCurrency = 'usd';
                let activeTableFilter = 'todos';
                
                const TIPO_DE_CAMBIO = (fullData.kpis.valorTotal.usd && fullData.kpis.valorTotal.usd > 0) ? (fullData.kpis.valorTotal.ars / fullData.kpis.valorTotal.usd) : 1;
                
                const formatPercent = (num, decimals = 2) => `${((num || 0) * 100).toFixed(decimals)}%`;
                const formatCurrency = (num, currency = currentCurrency, compact = false) => {
                    const number = num || 0;
                    if (compact && number >= 1000000) return new Intl.NumberFormat(currency === 'usd' ? 'en-US' : 'es-AR', { notation: "compact", compactDisplay: "short" }).format(number);
                    const options = currency === 'usd' 
                        ? { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 } 
                        : { style: 'currency', currency: 'ARS', minimumFractionDigits: 0, maximumFractionDigits: 0 };
                    return number.toLocaleString(currency === 'usd' ? 'en-US' : 'es-AR', options);
                }

                const textColor = '#a8b2d1';
                const gridColor = 'rgba(136, 146, 176, 0.1)';
                
                const assetAllocationChart = new Chart(document.getElementById('assetAllocationChart'), { type: 'doughnut', data: { datasets: [{ backgroundColor: ['#004B8D', '#FFC300', '#003366', '#D4A017', '#33A8FF', '#806000'], borderWidth: 0, cutout: '70%' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'right', labels: { color: textColor, padding: 20 } }, tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${formatCurrency(ctx.parsed, currentCurrency)} (${(ctx.parsed / ctx.chart.getDatasetMeta(0).total * 100).toFixed(1)}%)` } } } } });
                const topHoldingsChart = new Chart(document.getElementById('topHoldingsChart'), { type: 'bar', data: { datasets: [{ label: 'Valor', backgroundColor: '#004B8D', borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: textColor }, grid: { display: false } }, x: { ticks: { color: textColor, callback: (v) => formatCurrency(v, currentCurrency, true) }, grid: { color: gridColor } } } } });
                const performanceChart = new Chart(document.getElementById('performanceChart'), { type: 'line', data: { labels: [], datasets: [ { label: 'Mi Cartera', yAxisID: 'y-cartera', borderColor: '#36A2EB', backgroundColor: 'rgba(54, 162, 235, 0.1)', fill: true, tension: 0.4, borderWidth: 2, pointRadius: 2, pointHoverRadius: 5 }, { label: 'S&P 500 (Ref)', yAxisID: 'y-sp500', borderColor: '#FFC300', borderDash: [5, 5], fill: false, tension: 0.4, borderWidth: 2, pointRadius: 2, pointHoverRadius: 5, pointBackgroundColor: '#FFC300' } ] }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'top', align: 'center', labels: { color: textColor, usePointStyle: true, boxWidth: 8 } } }, scales: { 'y-cartera': { type: 'linear', position: 'left', beginAtZero: false, ticks: { color: textColor, callback: (v) => formatCurrency(v, currentCurrency, true) }, grid: { color: gridColor } }, 'y-sp500': { type: 'linear', position: 'right', beginAtZero: false, grid: { drawOnChartArea: false }, ticks: { color: textColor } }, x: { ticks: { autoSkip: true, maxTicksLimit: 15, color: textColor }, grid: { display: false } } } } });
                
                const modal = document.getElementById('asset-modal');
                const closeModalBtn = document.getElementById('close-asset-modal');
                const assetPriceChart = new Chart(document.getElementById('assetPriceChart'), {
                    type: 'line',
                    data: { labels: [], datasets: [{ label: 'Precio Hist√≥rico (USD)', borderColor: '#FFC300', tension: 0.1, pointRadius: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: textColor, autoSkip: true, maxTicksLimit: 10 } }, y: { ticks: { color: textColor } } }, plugins: { legend: { labels: { color: textColor } } } }
                });
                // correlationHeatmap ya no es necesario
                // let correlationHeatmap = null; 

                function showAssetModal(ticker) {
                    const assetData = fullData.carteraDetallada.find(a => a.ticker === ticker);
                    const priceHistory = (fullData.historicoPreciosActivos && fullData.historicoPreciosActivos[ticker]) ? fullData.historicoPreciosActivos[ticker] : [];
                    const dividendos = (fullData.resumenDividendos.porTicker || []).find(d => d.ticker === ticker);
                    const rentas = (fullData.resumenRentaFija.porTicker || []).find(r => r.ticker === ticker);
                    if (!assetData) return;
                    document.getElementById('modal-ticker-title').textContent = ticker;
                    document.getElementById('modal-valor-actual').textContent = formatCurrency(assetData.valorUSD);
                    document.getElementById('modal-costo-total').textContent = formatCurrency(assetData.costoUSD);
                    const plElem = document.getElementById('modal-pl-total');
                    plElem.textContent = formatPercent(assetData.plPorcentaje);
                    plElem.style.color = assetData.plPorcentaje >= 0 ? 'var(--positive)' : 'var(--negative)';
                    const totalFlujos = (dividendos ? dividendos.monto : 0) + (rentas ? rentas.monto : 0);
                    document.getElementById('modal-flujos-cobrados').textContent = formatCurrency(totalFlujos);
                    
                    if (priceHistory.length > 0) {
                        assetPriceChart.data.labels = priceHistory.map(p => new Date(p[0]).toLocaleDateString('es-AR', {day:'numeric', month:'numeric'}));
                        assetPriceChart.data.datasets[0].data = priceHistory.map(p => p[1]);
                        assetPriceChart.update();
                    } else {
                        assetPriceChart.data.labels = [];
                        assetPriceChart.data.datasets[0].data = [];
                        assetPriceChart.update();
                    }
                    
                    modal.style.display = 'flex';
                }

                closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
                modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

                const spySlider = document.getElementById('spy-slider');
                const cclSlider = document.getElementById('ccl-slider');
                const spySliderValue = document.getElementById('spy-slider-value');
                const cclSliderValue = document.getElementById('ccl-slider-value');
                const simulatedValueElem = document.getElementById('simulated-value');

                function runSimulation() {
                    if (!fullData.metricasQuant || typeof fullData.kpis.valorTotal.usd !== 'number') {
                        simulatedValueElem.textContent = "N/D"; 
                        simulatedValueElem.style.color = 'var(--slate)';
                        return;
                    }
                    const spyChange = parseFloat(spySlider.value) / 100;
                    const cclChange = parseFloat(cclSlider.value) / 100;
                    spySliderValue.textContent = `${spySlider.value}%`;
                    cclSliderValue.textContent = `${cclSlider.value}%`;
                    const beta = fullData.metricasQuant.betaCartera || 0;
                    const portfolioChange = spyChange * beta;
                    const baseValueUsd = fullData.kpis.valorTotal.usd;
                    const simulatedValueUsd = baseValueUsd * (1 + portfolioChange);
                    const baseTc = TIPO_DE_CAMBIO;
                    const simulatedTc = baseTc * (1 + cclChange);
                    const simulatedValueArs = simulatedValueUsd * simulatedTc;
                    const valueToShow = currentCurrency === 'usd' ? simulatedValueUsd : simulatedValueArs;
                    simulatedValueElem.textContent = formatCurrency(valueToShow, currentCurrency);
                    const originalValue = currentCurrency === 'usd' ? baseValueUsd : fullData.kpis.valorTotal.ars;
                    simulatedValueElem.style.color = valueToShow >= originalValue ? 'var(--positive)' : 'var(--negative)';
                }
                
                [spySlider, cclSlider].forEach(slider => slider.addEventListener('input', runSimulation));

                function renderizarTablaHoldings(data, filter) {
                    const tableBody = document.getElementById('holdingsTableBody'); 
                    tableBody.innerHTML = '';
                    const filteredData = Array.isArray(data) ? (filter === 'todos' ? data : data.filter(a => a.tipo === filter)) : [];
                    
                    if (filteredData.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--slate);">No hay posiciones que coincidan con el filtro.</td></tr>`;
                        return;
                    }

                    filteredData.sort((a, b) => (b.valorUSD || 0) - (a.valorUSD || 0)).forEach(activo => { // A√±adir (|| 0) para seguridad
                        const row = document.createElement('tr');
                        row.dataset.ticker = activo.ticker;
                        const plClass = (activo.plPorcentaje || 0) >= 0 ? 'positive' : 'negative'; 
                        const diarioClass = (activo.variacionDiaria || 0) >= 0 ? 'positive' : 'negative';
                        const costo = currentCurrency === 'usd' ? (activo.costoUSD || 0) : (activo.costoUSD || 0) * TIPO_DE_CAMBIO; 
                        const valorPosicion = currentCurrency === 'usd' ? (activo.valorUSD || 0) : (activo.valorUSD || 0) * TIPO_DE_CAMBIO;
                        
                        row.innerHTML = `
                            <td><strong>${activo.ticker || 'N/D'}</strong></td>
                            <td>${activo.tipo || 'N/D'}</td>
                            <td class="text-right">${formatCurrency(costo)}</td>
                            <td class="text-right">${formatCurrency(valorPosicion)}</td>
                            <td class="text-center"><span class="pl-badge ${diarioClass}">${formatPercent(activo.variacionDiaria, 1)}</span></td>
                            <td class="text-center"><span class="pl-badge ${plClass}">${formatPercent(activo.plPorcentaje, 1)}</span></td>
                            <td class="text-right">${formatPercent(activo.porcentajeCartera, 2)}</td>
                        `;
                        row.addEventListener('click', () => showAssetModal(activo.ticker));
                        tableBody.appendChild(row);
                    });
                }
                function renderizarTablaResumen(tbodyId, data, total, col1, col2) {
                    const tbody = document.getElementById(tbodyId); 
                    tbody.innerHTML = '';
                    if (!Array.isArray(data) || data.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; color: var(--slate);">No hay datos</td></tr>`;
                        return;
                    }
                    data.forEach(item => { 
                        tbody.innerHTML += `
                            <tr>
                                <td><strong>${item[col1] || 'N/D'}</strong></td>
                                <td class="text-right">${formatCurrency(item[col2], 'usd')}</td>
                                <td class="text-right">${(total > 0 ? ((item[col2] || 0) / total * 100) : 0).toFixed(1)}%</td>
                            </tr>
                        `; 
                    });
                }
                function updateFlujoDetalladoTable(data) {
                    const selectedYear = document.getElementById('year-selector').value;
                    const tableBody = document.getElementById('flujoDetalladoBody');
                    const totalAnualDiv = document.getElementById('flujoAnualTotal');

                    if (!tableBody || !totalAnualDiv) {
                        console.error("Elementos de la tabla de flujo no encontrados.");
                        return;
                    }
                    tableBody.innerHTML = ''; 
                    totalAnualDiv.innerHTML = '';

                    const filteredData = Array.isArray(data) ? data.filter(item => new Date(item.fecha).getFullYear() == selectedYear) : [];

                    if (filteredData.length === 0) { 
                        tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--slate);">No hay cobros para este a√±o o datos insuficientes.</td></tr>'; 
                        totalAnualDiv.innerHTML = `<span>Total Renta: ${formatCurrency(0, 'usd')}</span> | <span>Total Capital: ${formatCurrency(0, 'usd')}</span> | <span style="color: var(--gold);">Total General: ${formatCurrency(0, 'usd')}</span>`;
                        return; 
                    }

                    let totalRentaAnual = 0; 
                    let totalCapitalAnual = 0; 
                    let totalGeneralAnual = 0;
                    
                    filteredData.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
                    
                    filteredData.forEach(item => {
                        const renta = item.renta || 0;
                        const capital = item.capital || 0;
                        const totalFila = renta + capital;

                        totalRentaAnual += renta; 
                        totalCapitalAnual += capital; 
                        totalGeneralAnual += totalFila;
                        
                        tableBody.innerHTML += `
                            <tr>
                                <td><strong>${item.ticker || 'N/D'}</strong></td>
                                <td>${new Date(item.fecha).toLocaleDateString('es-AR', {day: '2-digit', month: '2-digit'})}</td>
                                <td class="text-right">${formatCurrency(renta, 'usd')}</td>
                                <td class="text-right">${formatCurrency(capital, 'usd')}</td>
                                <td class="text-right" style="font-weight: bold;">${formatCurrency(totalFila, 'usd')}</td>
                            </tr>
                        `;
                    });

                    totalAnualDiv.innerHTML = `<span>Total Renta: ${formatCurrency(totalRentaAnual, 'usd')}</span> | <span>Total Capital: ${formatCurrency(totalCapitalAnual, 'usd')}</span> | <span style="color: var(--gold);">Total General: ${formatCurrency(totalGeneralAnual, 'usd')}</span>`;
                }
                
                // Funci√≥n renderCorrelationHeatmap eliminada

                function updateVisuals() {
                    const kpis = fullData.kpis; 
                    const metricasQuant = fullData.metricasQuant;
                    
                    if (!kpis || !metricasQuant) { 
                        console.error("Datos KPI o M√©tricas Cuantitativas no encontrados en la respuesta."); 
                        document.getElementById('loading-overlay').innerHTML = `<div style="text-align:center; padding: 20px; max-width: 80%;"><h1 style="color:red;">Error de Datos</h1><p style="color:#ff8a8a;margin-top:10px;">Faltan datos esenciales (KPIs o M√©tricas Cuantitativas) en la respuesta del script.</p><p style="color:yellow;margin-top:20px;font-size:0.9rem;">Verifica la estructura JSON que devuelve tu Google Apps Script.</p></div>`;
                        return; 
                    }

                    document.querySelectorAll('.kpi-card').forEach(card => card.classList.toggle('ars-active', currentCurrency === 'ars'));
                    document.getElementById('valorTotal').textContent = formatCurrency(currentCurrency === 'usd' ? (kpis.valorTotal.usd || 0) : (kpis.valorTotal.ars || 0));
                    
                    const totalDiarioAbs = (fullData.carteraDetallada || []).reduce((sum, p) => sum + ((p.valorUSD || 0) * (p.variacionDiaria || 0)), 0);
                    const kpisValorTotalUsd = kpis.valorTotal.usd || 0;
                    const totalDiarioPorc = (kpisValorTotalUsd > 0) ? totalDiarioAbs / (kpisValorTotalUsd - totalDiarioAbs) : 0;
                    
                    const subValorElem = document.getElementById('valorTotalDiario');
                    subValorElem.textContent = `${formatCurrency(totalDiarioAbs * (currentCurrency === 'usd' ? 1 : TIPO_DE_CAMBIO))} (${formatPercent(totalDiarioPorc, 2)})`;
                    subValorElem.className = `sub-value ${totalDiarioAbs >= 0 ? 'positive' : 'negative'}`;
                    
                    const ganRealizadasElem = document.getElementById('ganRealizadas');
                    const ganNoRealizadasElem = document.getElementById('ganNoRealizadas');
                    const ganRealizadasNum = kpis.gananciasRealizadas.usd || 0;
                    const ganNoRealizadasNum = kpis.gananciasNoRealizadas.usd || 0;
                    ganRealizadasElem.textContent = formatCurrency(ganRealizadasNum * (currentCurrency === 'usd' ? 1 : TIPO_DE_CAMBIO));
                    ganNoRealizadasElem.textContent = formatCurrency(ganNoRealizadasNum * (currentCurrency === 'usd' ? 1 : TIPO_DE_CAMBIO));
                    ganRealizadasElem.className = `value ${ganRealizadasNum >= 0 ? 'positive' : 'negative'}`;
                    ganNoRealizadasElem.className = `value ${ganNoRealizadasNum >= 0 ? 'positive' : 'negative'}`;

                    const tirVariableElem = document.getElementById('tirVariable');
                    const tirFijaElem = document.getElementById('tirFija');
                    tirVariableElem.textContent = formatPercent(kpis.tirVariable, 2);
                    tirFijaElem.textContent = formatPercent(kpis.tirFija, 2);
                    tirVariableElem.className = `value ${kpis.tirVariable >= 0 ? 'positive' : 'negative'}`;
                    tirFijaElem.className = `value ${kpis.tirFija >= 0 ? 'positive' : 'negative'}`;

                    document.getElementById('volatilidadAnualizada').textContent = formatPercent(metricasQuant.volatilidadAnualizada || 0, 2);
                    document.getElementById('sharpeRatio').textContent = (metricasQuant.sharpeRatio || 0).toFixed(2);
                    document.getElementById('betaCartera').textContent = (metricasQuant.betaCartera || 0).toFixed(2);
                    document.getElementById('maxDrawdown').textContent = formatPercent(metricasQuant.maxDrawdown || 0, 2);
                    
                    if (fullData.distribucionTipos) {
                        assetAllocationChart.data.labels = Object.keys(fullData.distribucionTipos);
                        assetAllocationChart.data.datasets[0].data = Object.values(fullData.distribucionTipos).map(v => v * (currentCurrency === 'usd' ? 1 : TIPO_DE_CAMBIO));
                    }
                    
                    if (fullData.mejoresPosiciones) {
                        const activeGraphFilter = document.querySelector('#top-holdings-filters .filter-btn.active').dataset.category;
                        const categoryData = fullData.mejoresPosiciones[activeGraphFilter] || [];
                        topHoldingsChart.data.labels = categoryData.map(item => item.ticker);
                        topHoldingsChart.data.datasets[0].data = categoryData.map(item => (item.valorUSD || 0) * (currentCurrency === 'usd' ? 1 : TIPO_DE_CAMBIO));
                    }
                    
                    if (fullData.evolucionHistorica && fullData.evolucionHistorica.fechas && fullData.evolucionHistorica.valores && fullData.evolucionHistorica.benchmark) {
                        const activePeriodFilter = document.querySelector('#evolution-filters .filter-btn.active').dataset.period;
                        const { fechas, valores, benchmark } = fullData.evolucionHistorica;
                        let dataFiltrada = fechas.map((f, i) => ({ fecha: new Date(f), valor: valores[i] || 0, bench: benchmark[i] || 0 }));
                        
                        if (activePeriodFilter !== 'all') {
                            if (activePeriodFilter === 'ytd') {
                                const currentYear = new Date().getFullYear();
                                dataFiltrada = dataFiltrada.filter(d => d.fecha.getFullYear() === currentYear);
                            } else { 
                                const days = parseInt(activePeriodFilter, 10); 
                                dataFiltrada = dataFiltrada.slice(-days); 
                            }
                        }
                        performanceChart.data.labels = dataFiltrada.map(d => d.fecha.toLocaleDateString('es-AR', {day: 'numeric', month: 'numeric'}));
                        performanceChart.data.datasets[0].data = dataFiltrada.map(d => d.valor * (currentCurrency === 'usd' ? 1 : TIPO_DE_CAMBIO));
                        performanceChart.data.datasets[1].data = dataFiltrada.map(d => d.bench);
                    }

                    renderizarTablaHoldings(fullData.carteraDetallada, activeTableFilter);
                    
                    renderizarTablaResumen('dividendosGoleadoresBody', (fullData.resumenDividendos ? fullData.resumenDividendos.porTicker : []).slice(0, 5), (fullData.resumenDividendos ? fullData.resumenDividendos.total : 0), 'ticker', 'monto');
                    renderizarTablaResumen('dividendosTemporadaBody', (fullData.resumenDividendos ? fullData.resumenDividendos.porAno : []), (fullData.resumenDividendos ? fullData.resumenDividendos.total : 0), 'ano', 'monto');
                    renderizarTablaResumen('rentaFijaTemporadaBody', (fullData.resumenRentaFija ? fullData.resumenRentaFija.porAno : []), (fullData.resumenRentaFija ? fullData.resumenRentaFija.total : 0), 'ano', 'monto');
                    
                    const flujoDetalladoData = fullData.flujoFuturoRentaFija ? (fullData.flujoFuturoRentaFija.porFecha || []) : [];
                    const yearSelector = document.getElementById('year-selector');
                    if (yearSelector.options.length === 0 && flujoDetalladoData.length > 0) {
                        const years = [...new Set(flujoDetalladoData.map(item => new Date(item.fecha).getFullYear()))].sort();
                        years.forEach(year => { const option = document.createElement('option'); option.value = year; option.textContent = year; yearSelector.appendChild(option); });
                        if(years.length > 0) yearSelector.value = years[0];
                        yearSelector.addEventListener('change', () => updateFlujoDetalladoTable(flujoDetalladoData));
                    }
                    updateFlujoDetalladoTable(flujoDetalladoData);

                    [assetAllocationChart, topHoldingsChart, performanceChart].forEach(chart => chart.update('none'));
                    runSimulation();
                    // renderCorrelationHeatmap(fullData.matrizCorrelacion); // Llamada eliminada
                }
                
                document.querySelectorAll('.filter-buttons .filter-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const parent = e.target.closest('.filter-buttons');
                        parent.querySelector('.active').classList.remove('active');
                        e.target.classList.add('active');
                        if (parent.id === 'holdings-table-filters') {
                            activeTableFilter = e.target.dataset.category;
                        }
                        updateVisuals();
                    });
                });
                document.querySelectorAll('.currency-toggle .toggle-btn').forEach(button => { button.addEventListener('click', (e) => { document.querySelector('.currency-toggle .active').classList.remove('active'); e.target.classList.add('active'); currentCurrency = e.target.id === 'btn-usd' ? 'usd' : 'ars'; updateVisuals(); runSimulation(); }); });
                
                updateVisuals();

            } catch (error) {
                console.error('Error al iniciar el dashboard:', error);
                const loadingOverlay = document.getElementById('loading-overlay');
                loadingOverlay.innerHTML = `<div style="text-align:center; padding: 20px; max-width: 80%;"><h1 style="color:red;">Error Cr√≠tico</h1><p style="color:#ff8a8a;margin-top:10px;">${error.message}</p><p style="color:yellow;margin-top:20px;font-size:0.9rem;">Revis√° la consola (F12) para m√°s detalles. Aseg√∫rate de que el script de Google Apps Script est√© implementado correctamente y devuelve un JSON v√°lido.</p></div>`;
            }
        });
    </script>
</body>
</html>